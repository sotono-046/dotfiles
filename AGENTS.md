# エージェント運用ガイド

**重要: すべてのコミュニケーションは日本語で行います**

---

## 基本概念

このガイドは、Claude Code のサブエージェント（Task ツール）を活用した並列処理による効率的なタスク実行のための運用ルールを定めます。

---

## サブエージェント運用

### 基本方針

複雑なタスクは、Task ツールを使用してサブエージェントを並列で起動し、効率的に処理します。

### 利用可能なサブエージェント

| サブエージェント       | 役割                         | 並列数目安 |
| ---------------------- | ---------------------------- | ---------- |
| pre-task-investigator  | 事前調査・コンテキスト収集   | 2〜3 体    |
| task-splitter-executor | タスク分割・実装実行         | 3 体       |
| code-quality-reviewer  | コードレビュー・品質チェック | 1〜2 体    |
| Explore                | コードベース探索・検索       | 1〜2 体    |
| Plan                   | 実装計画の設計               | 1 体       |

### 並列実行の原則

1. **調査フェーズ**: pre-task-investigator を複数体並列で起動し、異なる観点から調査
2. **実装フェーズ**: task-splitter-executor を複数体並列で起動し、独立したサブタスクを同時実行
3. **検証フェーズ**: code-quality-reviewer で品質チェック、問題があれば修正

### サブエージェントの起動方法

Task ツールを使用してサブエージェントを起動します。並列実行する場合は、1 つのメッセージ内で複数の Task ツールコールを行います。

#### 並列調査の例

```
Task ツールを 2 回並列で呼び出し:
- subagent_type: pre-task-investigator
  prompt: "認証周りの現状実装を調査してください"
- subagent_type: pre-task-investigator
  prompt: "関連する API エンドポイントを調査してください"
```

#### バックグラウンド実行

長時間かかるタスクは `run_in_background: true` を指定してバックグラウンドで実行し、`TaskOutput` ツールで結果を取得します。

### 注意事項

- Write/Edit 権限はメインエージェントのみが持つ
- サブエージェントは調査・下書き・レビューに専念
- 競合を避けるため、同じファイルを複数エージェントが同時編集しない
- 各エージェントの完了を待ってから次フェーズへ進む
- `--dangerously-skip-permissions` は使用禁止

---

## プランレビュー

### 基本フロー

1. プランを立てる
1. プランをファイルとして保存
1. 別のエージェントを使ってプランファイルをレビュー依頼
1. 複数回相談してブラッシュアップ
1. ユーザーに提案
1. 承認後、プランをファイルとして保存

### レビューの方法

- レビューは自分のセッション内で行わず、別の単発セッションを作成して行う。
- Claude にレビューであれば`claude -p レビューの内容`というコマンドを使用する。

### マークダウンファイル作成

- 指示されない限り基本的に`[プロジェクト名]/.temp/YYMMDD/YYMMDD-<タイトル>.md`としてファイルを作成する
- 日付は`date +%y%m%d`コマンドで明示的に取得し、間違いないようにする

### レビューの原則

- 厳しくレビューする
- コードベースを根拠にする
- パッチの作成は提案しない
- プランは原則 SOW として作成

### SOW の作成

- フェーズごとに作業を分ける
- すべてのフェーズをひとつのファイルにまとめる

### SOW の実行

- SOW に即した名前のブランチを切って作業を行う
- フェーズの作業が完了したら下記の順番で品質チェックを行ってからコミットする
  - 型チェック
  - ESLint エラーがないこと
  - 既存のテストが通ること
  - claude でレビューを行う

---

## Git 運用

### コミットメッセージ

Conventional Commits 形式に準拠します。

```
feat(wedo): add retry queue
fix(auth): resolve token expiry
```

### プルリクエスト要件

各 PR には以下を記載します。

- [ ] 変更概要
- [ ] 関連イシュー番号
- [ ] UI 変更の証跡（スクリーンショット等）
- [ ] マイグレーション・Cloud Run タスク・マニフェスト変更の注意事項
- [ ] ローカルでの`pnpm ci`実行確認
- [ ] スキップしたチェックがあれば理由明記

### PR・イシュー作成時の注意

- **必ず日本語で書く**（英語で書きがちなので注意）
- 長文をワンライナーで送ると失敗するため、`.temp/YYMMDD/YYMMDD-PR-<タイトル>.md` というファイルを作成して使用

### ワークツリーの分離

ユーザーから指示があったときのみ、`wtp`コマンドを使用します。

```bash
# 使い方を確認
wtp --help

# main ブランチを最新にしてから実行
wtp add -b feature/add-new-feature
```
