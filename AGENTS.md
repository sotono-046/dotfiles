# エージェント運用ガイド

**重要: すべてのコミュニケーションは日本語で行います**

---

## サブエージェント運用

### 基本方針

タスクは、Task ツールを使用してサブエージェントを並列で起動し、効率的に処理します。
基本許可される限り効率良く並列実行します。

### 利用可能なサブエージェント

| サブエージェント       | 役割                         | 
| ---------------------- | ---------------------------- | 
| pre-task-investigator  | 事前調査・コンテキスト収集   | 
| task-splitter-executor | タスク分割・実装実行         | 
| code-quality-reviewer  | コードレビュー・品質チェック | 
| Explore                | コードベース探索・検索       | 
| Plan                   | 実装計画の設計               | 

### 並列実行の原則

1. **調査フェーズ**: pre-task-investigator を複数体並列で起動し、異なる観点から調査
2. **実装フェーズ**: task-splitter-executor を複数体並列で起動し、独立したサブタスクを同時実行
3. **検証フェーズ**: code-quality-reviewer で品質チェック、問題があれば修正

### サブエージェントの起動方法

Task ツールを使用してサブエージェントを起動します。
並列実行する場合は、1 つのメッセージ内で複数の Task ツールコールを行います。

#### 並列調査の例

```
Task ツールを 2 回並列で呼び出し:
- subagent_type: pre-task-investigator
  prompt: "認証周りの現状実装を調査してください"
- subagent_type: pre-task-investigator
  prompt: "関連する API エンドポイントを調査してください"
```

#### バックグラウンド実行

長時間かかるタスクは `run_in_background: true` を指定してバックグラウンドで実行し、`TaskOutput` ツールで結果を取得します。
また、ユーザーに確認させるときに開発サーバーを立ててユーザーに確認させます。

### 注意事項

- 競合を避けるため、同じファイルを複数エージェントが同時編集しない
- 各エージェントの完了を待ってから次フェーズへ進む

---

## プランレビュー

### 基本フロー

1. プランを立てる
1. プランをファイルとして保存
1. **必ず** `claude -p` または `codex MCP` を使ってレビューを行う
1. レビューが厳しく行われ、**承認されるまで繰り返し**継続
1. プランを保存する
1. ユーザーに提案
1. 承認後、最終版プランをファイルとして保存
1. プランに基づいてブランチを切る

### レビューの方法

- レビューは自分のセッション内で行わず、別の単発セッションを作成して行う
- **必須**: 以下のいずれかの方法でレビューを実施すること
  - Claude: `claude -p "レビュー内容"`
  - Codex MCP: `mcp_codex_codex` ツールを使用
- レビューが承認されるまで修正とレビューを繰り返す
- 承認基準を満たさない場合は、指摘事項を修正して再レビュー

### プランファイルの保存

- 保存場所: `settings.json` の `plansDirectory` で指定されたディレクトリ（`./.temp/plans`）
- 命名規則: `YYMMDD-<タイトル>.md`
- 日付は `date +%y%m%d` コマンドで明示的に取得し、間違いないようにする

### レビューの原則

- **厳しくレビューする**（承認されるまで繰り返し実施）
- コードベースを根拠にする
- パッチの作成は提案しない
- プランは原則 SOW として作成

### SOW の作成

- フェーズごとに作業を分ける
- すべてのフェーズをひとつのファイルにまとめる

### SOW の実行

- SOW に即した名前のブランチを切って作業を行う
- フェーズの作業が完了したら下記の順番で品質チェックを行ってからコミットする
  - 型チェック
  - ESLint エラーがないこと
  - 既存のテストが通ること
  - claude でレビューを行う

---

## Git 運用

### コミットメッセージ

Conventional Commits 形式に準拠します。

```
feat(wedo): add retry queue 
fix(auth): resolve token expiry
```

### プルリクエスト要件

各 PR には以下を記載します。

- 変更概要
- 関連イシュー番号
- UI 変更の証跡（スクリーンショット等）
- マイグレーション・Cloud Run タスク・マニフェスト変更の注意事項
- ローカルでの`pnpm ci`実行確認
- スキップしたチェックがあれば理由明記

### PR・イシュー作成時の注意

- **必ず日本語で書く**（英語で書きがちなので注意）
- 長文をワンライナーで送ると失敗するため、`.temp/YYMMDD/PR/YYMMDD-PR-<タイトル>.md` というファイルを作成して使用

### ワークツリーの分離

ユーザーから指示があったときのみ、`wtp`コマンドを使用します。

```bash
# 使い方を確認
wtp --help

# main ブランチを最新にしてから実行
wtp add -b feature/add-new-feature
```

